{
  "api_info": {
    "name": "ERP Lynx - Authentication API",
    "version": "1.0.0",
    "base_url": "http://localhost:8000/api/v1",
    "description": "Documentação completa das rotas de autenticação do ERP Lynx"
  },
  "endpoints": [
    {
      "id": "health_check",
      "name": "Health Check",
      "method": "GET",
      "path": "/health",
      "description": "Verifica se a API está operacional",
      "authentication_required": false,
      "request": {
        "headers": {},
        "query_params": {},
        "body": null
      },
      "response": {
        "success": {
          "status_code": 200,
          "content_type": "application/json",
          "body": {
            "status": "healthy",
            "service": "ERP Lynx API",
            "version": "1.0.0"
          }
        }
      },
      "examples": {
        "curl": "curl -X GET http://localhost:8000/api/v1/health"
      }
    },
    {
      "id": "login",
      "name": "Login",
      "method": "POST",
      "path": "/auth/login",
      "description": "Realiza autenticação do usuário com gestão de sessões concorrentes. Se o usuário já tiver uma sessão ativa, retorna conflito para que o cliente decida a ação.",
      "authentication_required": false,
      "request": {
        "headers": {
          "Content-Type": "application/json"
        },
        "query_params": {},
        "body": {
          "type": "object",
          "required": ["login", "senha"],
          "properties": {
            "login": {
              "type": "string",
              "description": "Login do usuário",
              "example": "admin"
            },
            "senha": {
              "type": "string",
              "description": "Senha do usuário",
              "example": "senha123"
            },
            "action": {
              "type": "string",
              "enum": ["new_session", "invalidate_previous"],
              "description": "Ação a tomar em caso de sessão ativa existente",
              "example": "invalidate_previous",
              "optional": true
            }
          }
        }
      },
      "response": {
        "success_without_conflict": {
          "status_code": 200,
          "description": "Login realizado com sucesso, não havia sessão ativa",
          "content_type": "application/json",
          "body": {
            "success": true,
            "session_conflict": false,
            "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "expired_at": "2025-11-10T14:30:00.000000",
            "user": {
              "uuid": "550e8400-e29b-41d4-a716-446655440000",
              "login": "admin",
              "nome": "Administrador Master",
              "email": "admin@lynxerp.com",
              "role": "master"
            }
          }
        },
        "success_with_conflict": {
          "status_code": 200,
          "description": "Usuário autenticado mas possui sessão ativa. Cliente deve decidir ação.",
          "content_type": "application/json",
          "body": {
            "success": false,
            "session_conflict": true,
            "message": "Usuário já possui sessão ativa",
            "active_sessions": 1
          }
        },
        "success_after_action": {
          "status_code": 200,
          "description": "Login realizado após ação de gestão de sessão",
          "content_type": "application/json",
          "body": {
            "success": true,
            "session_conflict": false,
            "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "expired_at": "2025-11-10T14:30:00.000000",
            "user": {
              "uuid": "550e8400-e29b-41d4-a716-446655440000",
              "login": "admin",
              "nome": "Administrador Master",
              "email": "admin@lynxerp.com",
              "role": "master"
            }
          }
        },
        "error_invalid_credentials": {
          "status_code": 401,
          "description": "Credenciais inválidas",
          "content_type": "application/json",
          "body": {
            "detail": "Credenciais inválidas"
          }
        },
        "error_user_inactive": {
          "status_code": 403,
          "description": "Usuário está inativo",
          "content_type": "application/json",
          "body": {
            "detail": "Usuário inativo"
          }
        },
        "error_server": {
          "status_code": 500,
          "description": "Erro interno do servidor",
          "content_type": "application/json",
          "body": {
            "detail": "Erro ao realizar login: [mensagem de erro]"
          }
        }
      },
      "examples": {
        "curl_first_login": "curl -X POST http://localhost:8000/api/v1/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"login\": \"admin\",\n    \"senha\": \"senha123\"\n  }'",
        "curl_with_conflict": "curl -X POST http://localhost:8000/api/v1/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"login\": \"admin\",\n    \"senha\": \"senha123\"\n  }'",
        "curl_invalidate_previous": "curl -X POST http://localhost:8000/api/v1/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"login\": \"admin\",\n    \"senha\": \"senha123\",\n    \"action\": \"invalidate_previous\"\n  }'",
        "curl_new_session": "curl -X POST http://localhost:8000/api/v1/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"login\": \"admin\",\n    \"senha\": \"senha123\",\n    \"action\": \"new_session\"\n  }'"
      },
      "notes": [
        "A primeira tentativa de login sem sessão ativa retorna o token diretamente",
        "Se já houver sessão ativa, o backend retorna session_conflict=true",
        "O cliente deve então reenviar a requisição com o parâmetro 'action'",
        "action='invalidate_previous': invalida todas as sessões anteriores do usuário",
        "action='new_session': cria uma nova sessão sem invalidar as existentes",
        "O token JWT expira em 24 horas (configurável via ACCESS_TOKEN_EXPIRE_HOURS)"
      ]
    },
    {
      "id": "validate_token",
      "name": "Validar Token",
      "method": "GET",
      "path": "/auth/validate",
      "description": "Valida se um token JWT está ativo e retorna informações do usuário",
      "authentication_required": true,
      "request": {
        "headers": {
          "Authorization": "Bearer {token}",
          "description": "Token JWT obtido no login"
        },
        "query_params": {},
        "body": null
      },
      "response": {
        "success": {
          "status_code": 200,
          "description": "Token válido",
          "content_type": "application/json",
          "body": {
            "success": true,
            "valid": true,
            "user_uuid": "550e8400-e29b-41d4-a716-446655440000",
            "login": "admin",
            "role": "master"
          }
        },
        "error_invalid_format": {
          "status_code": 401,
          "description": "Formato de autorização inválido",
          "content_type": "application/json",
          "body": {
            "detail": "Formato de autorização inválido"
          }
        },
        "error_invalid_token": {
          "status_code": 401,
          "description": "Token inválido ou expirado",
          "content_type": "application/json",
          "body": {
            "detail": "Token inválido ou expirado"
          }
        },
        "error_server": {
          "status_code": 500,
          "description": "Erro interno do servidor",
          "content_type": "application/json",
          "body": {
            "detail": "Erro ao validar token: [mensagem de erro]"
          }
        }
      },
      "examples": {
        "curl": "curl -X GET http://localhost:8000/api/v1/auth/validate \\\n  -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\""
      },
      "notes": [
        "Este endpoint deve ser usado para verificar se um token ainda é válido",
        "Útil para manter o usuário logado ou redirecionar para login",
        "Verifica tanto a validade do JWT quanto se a sessão está ativa no banco",
        "Sessões podem ser invalidadas manualmente via logout"
      ]
    },
    {
      "id": "logout",
      "name": "Logout",
      "method": "POST",
      "path": "/auth/logout",
      "description": "Invalida a sessão atual do usuário",
      "authentication_required": true,
      "request": {
        "headers": {
          "Authorization": "Bearer {token}",
          "description": "Token JWT da sessão a ser invalidada"
        },
        "query_params": {},
        "body": null
      },
      "response": {
        "success": {
          "status_code": 200,
          "description": "Logout realizado com sucesso",
          "content_type": "application/json",
          "body": {
            "success": true,
            "message": "Logout realizado com sucesso"
          }
        },
        "error_invalid_format": {
          "status_code": 401,
          "description": "Formato de autorização inválido",
          "content_type": "application/json",
          "body": {
            "detail": "Formato de autorização inválido"
          }
        },
        "error_invalid_session": {
          "status_code": 401,
          "description": "Sessão inválida",
          "content_type": "application/json",
          "body": {
            "detail": "Sessão inválida"
          }
        },
        "error_server": {
          "status_code": 500,
          "description": "Erro interno do servidor",
          "content_type": "application/json",
          "body": {
            "detail": "Erro ao realizar logout: [mensagem de erro]"
          }
        }
      },
      "examples": {
        "curl": "curl -X POST http://localhost:8000/api/v1/auth/logout \\\n  -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\""
      },
      "notes": [
        "O logout marca a sessão como invalidada no banco de dados",
        "O token JWT deixa de ser válido imediatamente",
        "Mesmo que o JWT não tenha expirado, a sessão não será mais aceita",
        "O campo 'invalidated_at' é atualizado na tabela lynx_sessions"
      ]
    }
  ],
  "authentication": {
    "type": "Bearer Token (JWT)",
    "description": "O sistema utiliza tokens JWT para autenticação. Após o login bem-sucedido, o token deve ser incluído no header Authorization de todas as requisições protegidas.",
    "header_format": "Authorization: Bearer {token}",
    "token_expiration": "24 horas (padrão)",
    "token_payload": {
      "user_uuid": "UUID do usuário",
      "session_id": "UUID da sessão",
      "login": "Login do usuário",
      "role": "Perfil de acesso",
      "exp": "Timestamp de expiração"
    }
  },
  "session_management": {
    "concurrent_sessions": {
      "description": "O sistema permite gestão de sessões concorrentes",
      "options": [
        {
          "action": "new_session",
          "description": "Cria uma nova sessão independente mantendo as anteriores ativas",
          "use_case": "Usuário quer acessar de múltiplos dispositivos simultaneamente"
        },
        {
          "action": "invalidate_previous",
          "description": "Invalida todas as sessões anteriores e cria uma nova",
          "use_case": "Usuário quer garantir que apenas a sessão atual está ativa (segurança)"
        }
      ]
    },
    "session_lifecycle": {
      "creation": "Sessão criada ao realizar login com sucesso",
      "validation": "Verificada a cada requisição protegida",
      "expiration": "Sessão expira após 24 horas da criação",
      "invalidation": "Pode ser invalidada manualmente via logout"
    }
  },
  "error_handling": {
    "standard_errors": [
      {
        "status_code": 401,
        "description": "Não autorizado - credenciais inválidas ou token expirado"
      },
      {
        "status_code": 403,
        "description": "Proibido - usuário autenticado mas sem permissão ou inativo"
      },
      {
        "status_code": 500,
        "description": "Erro interno do servidor"
      }
    ],
    "error_response_format": {
      "detail": "Mensagem descritiva do erro"
    }
  },
  "security_notes": [
    "Senhas são sempre armazenadas com hash bcrypt (nunca em texto plano)",
    "Tokens JWT são assinados com SECRET_KEY configurável via .env",
    "Sessões expiram automaticamente após 24 horas",
    "Sessões podem ser invalidadas manualmente a qualquer momento",
    "Validação de sessão verifica tanto JWT quanto registro no banco",
    "Usuários inativos (active=0) não podem fazer login",
    "Usuários deletados logicamente (deleted_at != NULL) não podem fazer login"
  ]
}